/*
Deployment script for Exam

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "Exam"
:setvar DefaultFilePrefix "Exam"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL11.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL11.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ANSI_NULLS ON,
                ANSI_PADDING ON,
                ANSI_WARNINGS ON,
                ARITHABORT ON,
                CONCAT_NULL_YIELDS_NULL ON,
                QUOTED_IDENTIFIER ON,
                ANSI_NULL_DEFAULT ON,
                CURSOR_DEFAULT LOCAL 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET PAGE_VERIFY NONE 
            WITH ROLLBACK IMMEDIATE;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Rename refactoring operation with key 2bbff343-a4e9-4b6a-8041-871c937f1e48, 76f505b7-e1a9-4c20-be62-b9215a8ac459 is skipped, element [dbo].[ExamCategory].[Id] (SqlSimpleColumn) will not be renamed to CertificateId';


GO
PRINT N'Rename refactoring operation with key e30d86c3-5959-4e61-9555-c2e92812b449 is skipped, element [dbo].[Exam].[Id] (SqlSimpleColumn) will not be renamed to ExamId';


GO
PRINT N'Rename refactoring operation with key 9df8b22a-db76-4abf-98cb-a91e65d77e50, 6f7271f6-bfc9-46ad-94f3-4ce84c11b792 is skipped, element [dbo].[Question].[Id] (SqlSimpleColumn) will not be renamed to QuestionId';


GO
PRINT N'Rename refactoring operation with key 142b9413-975c-42cb-89d0-76eb1f45e6b2 is skipped, element [dbo].[Answer].[Id] (SqlSimpleColumn) will not be renamed to AnswerId';


GO
PRINT N'Rename refactoring operation with key 27f4cd5c-249e-4add-9b12-b5f21e782e23 is skipped, element [dbo].[Skill].[Id] (SqlSimpleColumn) will not be renamed to SkillId';


GO
PRINT N'Rename refactoring operation with key e732a82a-be06-4645-9903-59ee8ad973b6 is skipped, element [dbo].[ExamCategory].[ExamCategoryName] (SqlSimpleColumn) will not be renamed to CertificateName';


GO
PRINT N'Rename refactoring operation with key 5da75216-c693-48a4-9a62-2f87c1525157 is skipped, element [dbo].[Skill].[ExamId] (SqlSimpleColumn) will not be renamed to CertificateId';


GO
PRINT N'Rename refactoring operation with key abca0f1a-c326-4efb-9d2c-ba5863ec6f33 is skipped, element [dbo].[SkillDetail].[Id] (SqlSimpleColumn) will not be renamed to SkillDetailId';


GO
PRINT N'Rename refactoring operation with key ad793e46-6be6-443e-bcdb-f9032c80f0b5 is skipped, element [dbo].[Question].[ExamId] (SqlSimpleColumn) will not be renamed to CertificateId';


GO
PRINT N'Rename refactoring operation with key 1bfc6dba-a614-4d0a-8741-02467dcfaa84 is skipped, element [dbo].[UserProfile].[Id] (SqlSimpleColumn) will not be renamed to UserProfileId';


GO
PRINT N'Rename refactoring operation with key dd3818a3-bbe0-4358-a045-5212d2b0d84e is skipped, element [dbo].[QuestionLevel].[Id] (SqlSimpleColumn) will not be renamed to QuestionLevelId';


GO
PRINT N'Creating [dbo].[Answer]...';


GO
CREATE TABLE [dbo].[Answer] (
    [AnswerId]        INT            NOT NULL,
    [RowId]           INT            NULL,
    [QuestionId]      BIGINT         NULL,
    [Description]     NVARCHAR (MAX) NULL,
    [IsCorrectAnswer] BIT            NULL,
    [CreatedDate]     DATETIME       NULL,
    [CreatedBy]       NVARCHAR (50)  NULL,
    [ModifiedDate]    DATETIME       NULL,
    [ModifiedBy]      NVARCHAR (50)  NULL,
    PRIMARY KEY CLUSTERED ([AnswerId] ASC)
);


GO
PRINT N'Creating [dbo].[Certificate]...';


GO
CREATE TABLE [dbo].[Certificate] (
    [CertificateId]   INT            NOT NULL,
    [CompanyName]     NVARCHAR (500) NOT NULL,
    [CertificateCode] NVARCHAR (500) NOT NULL,
    [CertificateName] NVARCHAR (500) NOT NULL,
    [Technology]      NVARCHAR (500) NOT NULL,
    [PublishDate]     DATETIME       NOT NULL,
    PRIMARY KEY CLUSTERED ([CertificateId] ASC)
);


GO
PRINT N'Creating [dbo].[Question]...';


GO
CREATE TABLE [dbo].[Question] (
    [QuestionId]            BIGINT         NOT NULL,
    [CertificateId]         INT            NOT NULL,
    [SkillId]               INT            NOT NULL,
    [SkillDetailId]         INT            NULL,
    [Title]                 NVARCHAR (MAX) NULL,
    [IsMultiChoice]         BIT            NULL,
    [CorrectAnswerCount]    INT            NULL,
    [AllowShuffleChoices]   BIT            NULL,
    [CheckNumberOfSelected] BIT            NULL,
    [Explanation]           NVARCHAR (MAX) NULL,
    [QuestionLevelId]       INT            NULL,
    [UserId]                NVARCHAR (500) NULL,
    [CreatedDate]           DATETIME       NULL,
    [CreatedBy]             NVARCHAR (50)  NULL,
    [ModifiedDate]          DATETIME       NULL,
    [ModifiedBy]            NVARCHAR (50)  NULL,
    PRIMARY KEY CLUSTERED ([QuestionId] ASC)
);


GO
PRINT N'Creating [dbo].[QuestionLevel]...';


GO
CREATE TABLE [dbo].[QuestionLevel] (
    [QuestionLevelId]   INT           NOT NULL,
    [QuestionLevelName] NVARCHAR (50) NOT NULL,
    PRIMARY KEY CLUSTERED ([QuestionLevelId] ASC)
);


GO
PRINT N'Creating [dbo].[Skill]...';


GO
CREATE TABLE [dbo].[Skill] (
    [SkillId]       INT            NOT NULL,
    [SkillName]     NVARCHAR (500) NOT NULL,
    [CertificateId] INT            NOT NULL,
    [SkillOrder]    INT            NOT NULL,
    PRIMARY KEY CLUSTERED ([SkillId] ASC)
);


GO
PRINT N'Creating [dbo].[SkillDetail]...';


GO
CREATE TABLE [dbo].[SkillDetail] (
    [SkillDetailId]          INT            NOT NULL,
    [SkillId]                INT            NOT NULL,
    [SkillDetailDescription] NVARCHAR (MAX) NULL,
    [SkillDetailOrder]       INT            NULL,
    PRIMARY KEY CLUSTERED ([SkillDetailId] ASC)
);


GO
PRINT N'Creating [dbo].[UserProfile]...';


GO
CREATE TABLE [dbo].[UserProfile] (
    [UserId]      NVARCHAR (500) NOT NULL,
    [Email]       NVARCHAR (500) NOT NULL,
    [FirstName]   NVARCHAR (500) NOT NULL,
    [LastName]    NVARCHAR (500) NULL,
    [CreatedDate] DATETIME       NULL,
    CONSTRAINT [PK_UserProfile] PRIMARY KEY CLUSTERED ([UserId] ASC)
);


GO
PRINT N'Creating FK_Answer_Question...';


GO
ALTER TABLE [dbo].[Answer] WITH NOCHECK
    ADD CONSTRAINT [FK_Answer_Question] FOREIGN KEY ([QuestionId]) REFERENCES [dbo].[Question] ([QuestionId]);


GO
PRINT N'Creating FK_Question_Certificate...';


GO
ALTER TABLE [dbo].[Question] WITH NOCHECK
    ADD CONSTRAINT [FK_Question_Certificate] FOREIGN KEY ([CertificateId]) REFERENCES [dbo].[Certificate] ([CertificateId]);


GO
PRINT N'Creating FK_Question_Skill...';


GO
ALTER TABLE [dbo].[Question] WITH NOCHECK
    ADD CONSTRAINT [FK_Question_Skill] FOREIGN KEY ([SkillId]) REFERENCES [dbo].[Skill] ([SkillId]);


GO
PRINT N'Creating FK_Question_SkillDetail...';


GO
ALTER TABLE [dbo].[Question] WITH NOCHECK
    ADD CONSTRAINT [FK_Question_SkillDetail] FOREIGN KEY ([SkillDetailId]) REFERENCES [dbo].[SkillDetail] ([SkillDetailId]);


GO
PRINT N'Creating FK_Question_UserProfile...';


GO
ALTER TABLE [dbo].[Question] WITH NOCHECK
    ADD CONSTRAINT [FK_Question_UserProfile] FOREIGN KEY ([UserId]) REFERENCES [dbo].[UserProfile] ([UserId]);


GO
PRINT N'Creating FK_Question_QuestionLevel...';


GO
ALTER TABLE [dbo].[Question] WITH NOCHECK
    ADD CONSTRAINT [FK_Question_QuestionLevel] FOREIGN KEY ([QuestionLevelId]) REFERENCES [dbo].[QuestionLevel] ([QuestionLevelId]);


GO
PRINT N'Creating FK_Skill_Certificate...';


GO
ALTER TABLE [dbo].[Skill] WITH NOCHECK
    ADD CONSTRAINT [FK_Skill_Certificate] FOREIGN KEY ([CertificateId]) REFERENCES [dbo].[Certificate] ([CertificateId]);


GO
PRINT N'Creating FK_Skill_SkillDetail...';


GO
ALTER TABLE [dbo].[SkillDetail] WITH NOCHECK
    ADD CONSTRAINT [FK_Skill_SkillDetail] FOREIGN KEY ([SkillId]) REFERENCES [dbo].[Skill] ([SkillId]);


GO
-- Refactoring step to update target server with deployed transaction logs

IF OBJECT_ID(N'dbo.__RefactorLog') IS NULL
BEGIN
    CREATE TABLE [dbo].[__RefactorLog] (OperationKey UNIQUEIDENTIFIER NOT NULL PRIMARY KEY)
    EXEC sp_addextendedproperty N'microsoft_database_tools_support', N'refactoring log', N'schema', N'dbo', N'table', N'__RefactorLog'
END
GO
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '2bbff343-a4e9-4b6a-8041-871c937f1e48')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('2bbff343-a4e9-4b6a-8041-871c937f1e48')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'e30d86c3-5959-4e61-9555-c2e92812b449')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('e30d86c3-5959-4e61-9555-c2e92812b449')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '9df8b22a-db76-4abf-98cb-a91e65d77e50')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('9df8b22a-db76-4abf-98cb-a91e65d77e50')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '6f7271f6-bfc9-46ad-94f3-4ce84c11b792')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('6f7271f6-bfc9-46ad-94f3-4ce84c11b792')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '142b9413-975c-42cb-89d0-76eb1f45e6b2')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('142b9413-975c-42cb-89d0-76eb1f45e6b2')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '27f4cd5c-249e-4add-9b12-b5f21e782e23')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('27f4cd5c-249e-4add-9b12-b5f21e782e23')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '76f505b7-e1a9-4c20-be62-b9215a8ac459')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('76f505b7-e1a9-4c20-be62-b9215a8ac459')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'e732a82a-be06-4645-9903-59ee8ad973b6')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('e732a82a-be06-4645-9903-59ee8ad973b6')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '5da75216-c693-48a4-9a62-2f87c1525157')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('5da75216-c693-48a4-9a62-2f87c1525157')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'abca0f1a-c326-4efb-9d2c-ba5863ec6f33')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('abca0f1a-c326-4efb-9d2c-ba5863ec6f33')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'ad793e46-6be6-443e-bcdb-f9032c80f0b5')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('ad793e46-6be6-443e-bcdb-f9032c80f0b5')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '1bfc6dba-a614-4d0a-8741-02467dcfaa84')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('1bfc6dba-a614-4d0a-8741-02467dcfaa84')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'dd3818a3-bbe0-4358-a045-5212d2b0d84e')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('dd3818a3-bbe0-4358-a045-5212d2b0d84e')

GO

GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[Answer] WITH CHECK CHECK CONSTRAINT [FK_Answer_Question];

ALTER TABLE [dbo].[Question] WITH CHECK CHECK CONSTRAINT [FK_Question_Certificate];

ALTER TABLE [dbo].[Question] WITH CHECK CHECK CONSTRAINT [FK_Question_Skill];

ALTER TABLE [dbo].[Question] WITH CHECK CHECK CONSTRAINT [FK_Question_SkillDetail];

ALTER TABLE [dbo].[Question] WITH CHECK CHECK CONSTRAINT [FK_Question_UserProfile];

ALTER TABLE [dbo].[Question] WITH CHECK CHECK CONSTRAINT [FK_Question_QuestionLevel];

ALTER TABLE [dbo].[Skill] WITH CHECK CHECK CONSTRAINT [FK_Skill_Certificate];

ALTER TABLE [dbo].[SkillDetail] WITH CHECK CHECK CONSTRAINT [FK_Skill_SkillDetail];


GO
PRINT N'Update complete.';


GO
